function ShowError(n,t){var i=n?"block":"none";document.getElementById("errorArea").style.display=i;document.getElementById("errorMessage").innerHTML=t}function UpdateJsonOutput(){var n=wc.Export();document.getElementById("json_output").innerHTML=JSON.stringify(n,undefined,2)}function ClearModel(){wc.Clear()}function LoadModel(){if(!savedModel){alert("No Flowchart saved. Please save one first.");return}wc.Load(savedModel)}function SaveModel(){var n=wc.Export();savedModel=n;$("#lastSave").text((new Date).toString())}function AddNewShape(){var n,t,i;try{var u=$("#shapeid").val(),o=$("input[name=shapetype]:checked").val(),f=parseInt($("#width").val()),e=parseInt($("#height").val()),s=parseInt($("#posx").val()),h=parseInt($("#posy").val()),c=$("#metadata").text(),r=new flowchart.shape.metadata.Html("");r.SetHtmlText(c);n=null;switch(o){case"terminal":n=new flowchart.shape.Terminal(u,f,e,r);break;case"process":n=new flowchart.shape.Process(u,f,e,r);break;case"decision":n=new flowchart.shape.Decision(u,f,e,r);break;default:throw"No ShapeType defined";}if(t=flowchart.constants.ConnectionPointType,i=flowchart.constants.ConnectionPointPosition,!n)return;n.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,i.Top),new flowchart.shape.ConnectionPoint(t.Incoming,i.Left),new flowchart.shape.ConnectionPoint(t.OutgoingFalseError,i.Right),new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,i.Bottom)]);wc.AddShape(n,s,h);ShowError(!1,"")}catch(l){ShowError(!0,l)}}var __extends=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);n.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)},wc,savedModel,common,flowchart;(function(n){var t;(function(n){(function(n){n[n.Terminal=1]="Terminal";n[n.Process=2]="Process";n[n.Decision=3]="Decision";n[n.ConnectionPoint=4]="ConnectionPoint"})(n.ShapeType||(n.ShapeType={}));var t=n.ShapeType})(t=n.constants||(n.constants={}))})(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(){}return n}();n.BaseElement=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(n){function t(){n.apply(this,arguments)}return __extends(t,n),t}(n.BaseElement);n.SelectableElement=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(i){function r(n,r,u,f,e,o){i.call(this);this.ConnectionPoints=[];this.Connections=[];this.Id=n;this.Type=r;this.Width=u;this.Height=f;this.CssBackgroundClass=o+"_background";this.CssContentClass=o+"_content";this.Metadata=e?e:new t.metadata.Html("");this.RaphaelAttr={fill:"white",stroke:"black","fill-opacity":0,"stroke-width":1,cursor:"move"}}return __extends(r,i),r.prototype.GetContainingElements=function(){var t=[this.RaphaelElement],n,i,r;for(this.RaphaelMetadata&&t.push(this.RaphaelMetadata),n=0,i=this.ConnectionPoints;n<i.length;n++)r=i[n],t.push(r.RaphaelElement);return t},r.prototype.BeforeMove=function(){for(var n,i,u=this.GetContainingElements(),t=0,r=u;t<r.length;t++)n=r[t],n.data?(i=n.data("shape").GetPosition(),n.ox=i.X,n.oy=i.Y):(n.ox=Number(n.getAttribute("x")),n.oy=Number(n.getAttribute("y")))},r.prototype.SetRaphaelShapeReference=function(){this.RaphaelElement.data("shape",this)},r.prototype.OnMove=function(n,t){for(var o=this.GetContainingElements(),r=0,u=o;r<u.length;r++){var i=u[r],f=i.ox+n,e=i.oy+t;i.attr?i.data("shape").SetPosition(f,e):(i.setAttributeNS(null,"x",String(f)),i.setAttributeNS(null,"y",String(e)))}},r.prototype.AddConnectionPoints=function(n){for(var r,t=0,i=n;t<i.length;t++)r=i[t],r.ParentShape=this,this.ConnectionPoints.push(r)},r.prototype.AddConnection=function(n){this.Connections.push(n)},r.prototype.CalculateConnectionPointCoord=function(t,i,r){var u=this.RaphaelElement.getBBox(),f=0,e=0;switch(t){case n.constants.ConnectionPointPosition.Top:f=u.x+u.width/2;e=u.y-r/2;break;case n.constants.ConnectionPointPosition.Left:f=u.x-i/2;e=u.y+u.height/2;break;case n.constants.ConnectionPointPosition.Right:f=u.x+u.width+i/2;e=u.y+u.height/2;break;case n.constants.ConnectionPointPosition.Bottom:f=u.x+u.width/2;e=u.y+u.height+r/2}return{x:f,y:e}},r.prototype.Delete=function(){var i,n,t;for(this.RaphaelElement&&this.RaphaelElement.remove(),this.RaphaelMetadata&&this.RaphaelMetadata.remove(),n=0,t=this.ConnectionPoints;n<t.length;n++)i=t[n],i.Delete()},r.prototype.SetCssContentClass=function(n){this.CssContentClass=n},r}(n.model.SelectableElement);t.ShapeBase=i})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(t){function i(i,r,u,f){f===void 0&&(f=null);t.call(this,i,n.constants.ShapeType.Process,r,u,f,"shape_process")}return __extends(i,t),i.prototype.DrawShape=function(n,t,i){var r=n.rect(t,i,this.Width,this.Height);return r.attr(this.RaphaelAttr),r},i.prototype.GetMetadataDiv=function(){var n=document.createElement("div");return n.classList.add(this.CssBackgroundClass),n},i.prototype.GetPosition=function(){return new n.model.ShapePosition(this.RaphaelElement.attr("x"),this.RaphaelElement.attr("y"))},i.prototype.SetPosition=function(n,t){this.RaphaelElement.attr({x:n,y:t})},i.prototype.OnSelect=function(n){this.RaphaelElement.data("origStroke",this.RaphaelElement.attr("stroke"));this.RaphaelElement.attr("stroke",n.ColorSelectedShape)},i.prototype.OnUnselect=function(){var n=this.RaphaelElement.data("origStroke");this.RaphaelElement.attr("stroke",n)},i}(t.ShapeBase);t.Process=i})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(t){function i(i,r,u,f){f===void 0&&(f=null);t.call(this,i,n.constants.ShapeType.Decision,r,u,f,"shape_decision")}return __extends(i,t),i.prototype.DrawShape=function(n,t,i){var u=this.CalculatePath(t,i,this.Width,this.Height),r=n.path(u.path);return r.attr({x:t,y:i}),r.attr(this.RaphaelAttr),r},i.prototype.CalculatePath=function(n,t,i,r){var u=r/2,f=i/2,e=n+f,o=t,s=n,h=t+u,c=n+i,l=t+u,a=n+f,v=t+r,y=e+","+o,p=c+","+l,w=s+","+h,b=a+","+v,k="M"+y+" "+p+" "+b+" "+w+" "+y;return{path:k,topX:e,topY:o,rightX:c,rightY:l,leftX:s,leftY:h,bottomX:a,bottomY:v}},i.prototype.GetMetadataDiv=function(){var n=document.createElement("div");return n.classList.add(this.CssBackgroundClass),n.style.width=this.Width*.7+"px",n.style.height=this.Height*.7+"px",n.style.marginLeft=this.Width*.49+"px",n.style.marginTop=this.Height*.29+"px",n},i.prototype.GetPosition=function(){return new n.model.ShapePosition(this.RaphaelElement.attr("x"),this.RaphaelElement.attr("y"))},i.prototype.SetPosition=function(n,t){var i=this.CalculatePath(n,t,this.Width,this.Height);this.RaphaelElement.node.setAttribute("d",i.path);this.RaphaelElement.attr({x:n,y:t})},i.prototype.OnSelect=function(n){this.RaphaelElement.data("origStroke",this.RaphaelElement.attr("stroke"));this.RaphaelElement.attr("stroke",n.ColorSelectedShape)},i.prototype.OnUnselect=function(){var n=this.RaphaelElement.data("origStroke");this.RaphaelElement.attr("stroke",n)},i}(t.ShapeBase);t.Decision=i})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t=function(){function n(n,t){this.options=n;this.eventHandler=t}return n.prototype.Initialize=function(n,t,i){t===void 0&&(t=0);i===void 0&&(i=0);this.Paper=Raphael(n,0,0);var r=t!==0?t:"100%",u=i!==0?i:"100%";this.Paper.setSize(r,u)},n.prototype.AddShape=function(n,t,i){var r,u,f;if(isNaN(t))throw"PosX is not a valid number.";if(isNaN(i))throw"PosY is not a valid number.";if(isNaN(n.Width))throw"Shape.Width is not a valid number.";if(isNaN(n.Height))throw"Shape.Height is not a valid number.";for(this.SetMetadata(n,n.Metadata,t,i),n.RaphaelElement=n.DrawShape(this.Paper,t,i),n.RaphaelElement.toFront(),n.SetRaphaelShapeReference(),u=0,f=n.ConnectionPoints;u<f.length;u++)r=f[u],r.RaphaelElement=r.DrawShape(this.Paper,t,i),r.SetRaphaelShapeReference()},n.prototype.SetMetadata=function(n,t,i,r){var f=this.Paper.canvas,u=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");u.setAttributeNS(null,"width",String(n.Width));u.setAttributeNS(null,"height",String(n.Height));u.setAttributeNS(null,"x",String(i));u.setAttributeNS(null,"y",String(r));u.setAttributeNS(null,"style","padding:1px");f.appendChild(u);n.RaphaelMetadata=u;this.UpdateMetadata(n,t)},n.prototype.UpdateMetadata=function(n,t){var r,u,i;if(!n)throw"UpdateMetadata: Shape is null.";if(!n.RaphaelMetadata)throw"UpdateMetadata: Shape.RapahelMetadata is null";for(r=n.GetMetadataDiv(),u=t.GetHtml(),u.classList.add(n.CssContentClass),r.appendChild(u),i=n.RaphaelMetadata.childNodes.length-1;i>=0;i--)n.RaphaelMetadata.removeChild(n.RaphaelMetadata.childNodes[i]);n.RaphaelMetadata.appendChild(r)},n}();n.Drawer=t}(flowchart||(flowchart={})),function(n){"use strict";var t=function(){function t(t,i,r,u){i||(i=new n.FlowChartOptions);this.namespaceRegistrator=new n.NamespaceRegistrator;this.model=new n.model.FlowChartModel;this.drawer=new n.Drawer(i,this.eventHandler);this.drawer.Initialize(t,r,u);i.Init(this.drawer.Paper);this.eventHandler=new n.EventHandler;this.selectionManager=new n.SelectionManager(this.eventHandler,i,this.model);this.connector=new n.ShapeConnector(this.drawer.Paper,i,this.eventHandler);this.mover=new n.ShapeMover(this.connector,this.drawer.Paper,i,this.eventHandler)}return t.prototype.Clear=function(){for(var f,n,r,t,i=0,u=this.model.Shapes;i<u.length;i++)for(t=u[i],t.Delete(),n=0,r=t.Connections;n<r.length;n++)f=r[n],f.Delete();this.model.Shapes=[]},t.prototype.Export=function(){return this.model.Export()},t.prototype.Load=function(t){this.Clear();var i=new n.ModelLoader(this,this.namespaceRegistrator);i.Load(t)},t.prototype.CheckShapeId=function(n){for(var r,t=0,i=this.model.Shapes;t<i.length;t++)if(r=i[t],r.Id==n)return!1;return!0},t.prototype.AddShape=function(t,i,r){var u=this;if(!t)throw"No Shape defined.";if(t.Id==null||t.Id.trim().length===0)throw"No shape.Id defined.";if(!this.CheckShapeId(t.Id))throw"The shapeId ["+t.Id+"] already exists.";this.drawer.AddShape(t,i,r);this.mover.Register(t);this.model.Shapes.push(t);t.RaphaelElement.click(function(){u.eventHandler.Notify(n.constants.EventType.OnClick,new n.model.EventParamShape(t))});t.RaphaelElement.dblclick(function(){u.eventHandler.Notify(n.constants.EventType.OnDoubleClick,new n.model.EventParamShape(t))})},t.prototype.UpdateShapeMetadata=function(n,t){t||(t=n.Metadata);this.drawer.UpdateMetadata(n,t)},t.prototype.ConnectShapes=function(n,t,i,r){var u=this.connector.Connect(n,t,i,r)},t.prototype.AddEventListener=function(n,t){this.eventHandler.Register(n,t)},t.prototype.GetShape=function(n){for(var r,t=0,i=this.model.Shapes;t<i.length;t++)if(r=i[t],r.Id==n)return r;return null},t.prototype.RegisterShape=function(n,t){this.namespaceRegistrator.RegisterShape(n,t)},t.prototype.RegisterConnectionDrawer=function(n,t){this.namespaceRegistrator.RegisterConnectionDrawer(n,t)},t.prototype.CheckShapeHasRaphaelElement=function(n){if(!n)throw"Parameter shape is null";if(!n.RaphaelElement)throw"shape.RaphaelElement is null";},t}();n.FlowChart=t}(flowchart||(flowchart={}));window.onload=function(){var o=new flowchart.FlowChartOptions;o.ShapeConnectionType=flowchart.constants.ConnectionDrawerType.Curved;o.ColorSelectedShape="blue";wc=new flowchart.FlowChart("myCanvas",o);var s=new flowchart.shape.Terminal("0",150,50,new flowchart.shape.metadata.Html("Start")),u=new flowchart.shape.Process("1",150,70,new flowchart.shape.metadata.Html("Do something")),r=new flowchart.shape.Decision("2",100,100,new flowchart.shape.metadata.Html("Ok?")),i=new flowchart.shape.Process("3",150,70,new flowchart.shape.metadata.Html("Yes")),f=new flowchart.shape.Process("4",150,70,new flowchart.shape.metadata.Html("No")),e=new flowchart.shape.Terminal("5",150,50,new flowchart.shape.metadata.Html("End")),t=flowchart.constants.ConnectionPointType,n=flowchart.constants.ConnectionPointPosition;s.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,n.Bottom)]);u.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,n.Top),new flowchart.shape.ConnectionPoint(t.Incoming,n.Left),new flowchart.shape.ConnectionPoint(t.OutgoingFalseError,n.Right),new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,n.Bottom)]);r.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,n.Top),new flowchart.shape.ConnectionPoint(t.OutgoingFalseError,n.Left),new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,n.Right)]);i.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,n.Top),new flowchart.shape.ConnectionPoint(t.Incoming,n.Left),new flowchart.shape.ConnectionPoint(t.OutgoingFalseError,n.Right),new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,n.Bottom)]);f.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,n.Top),new flowchart.shape.ConnectionPoint(t.Incoming,n.Left),new flowchart.shape.ConnectionPoint(t.OutgoingFalseError,n.Right),new flowchart.shape.ConnectionPoint(t.OutgoingTrueSuccess,n.Bottom)]);e.AddConnectionPoints([new flowchart.shape.ConnectionPoint(t.Incoming,n.Top)]);wc.AddShape(s,350,30);wc.AddShape(u,350,110);wc.AddShape(r,375,220);wc.AddShape(i,470,330);wc.AddShape(f,240,330);wc.AddShape(e,350,440);wc.ConnectShapes(s,u,n.Bottom,n.Top);wc.ConnectShapes(u,r,n.Bottom,n.Top);wc.ConnectShapes(r,i,n.Right,n.Top);wc.ConnectShapes(r,f,n.Left,n.Top);wc.ConnectShapes(i,e,n.Bottom,n.Top);wc.ConnectShapes(f,e,n.Bottom,n.Top);wc.AddEventListener(flowchart.constants.EventType.BeforeConnectionCreated,function(){return confirm("Do you really want to create this connection?")});wc.AddEventListener(flowchart.constants.EventType.AfterConnectionCreated,function(){return UpdateJsonOutput(),!0});wc.AddEventListener(flowchart.constants.EventType.OnClick,function(n){return console.log("single clicked "+n),!0});wc.AddEventListener(flowchart.constants.EventType.OnDoubleClick,function(n){return console.log("double clicked "+n),!0});wc.AddEventListener(flowchart.constants.EventType.BeforeDelete,function(){return confirm("do you really want to delete these elements?")});wc.AddEventListener(flowchart.constants.EventType.AfterDelete,function(){return UpdateJsonOutput(),console.log("elements deleted"),!0});wc.AddEventListener(flowchart.constants.EventType.BeforeShapeMoved,function(n){var t=n.Shape.GetPosition();return console.log("shape moved from "+t.X+":"+t.Y),!0});wc.AddEventListener(flowchart.constants.EventType.AfterShapeMoved,function(n){UpdateJsonOutput();var t=n.Shape.GetPosition();return console.log("shape moved to "+t.X+":"+t.Y),!0});wc.AddEventListener(flowchart.constants.EventType.BeforeSelect,function(n){var t=n instanceof flowchart.model.EventParamShape?n.Shape:n.ShapeConnection;return console.log("before shape ["+t.Id+"] selected"),!0});wc.AddEventListener(flowchart.constants.EventType.AfterSelect,function(n){var t=n instanceof flowchart.model.EventParamShape?n.Shape:n.ShapeConnection;return console.log("after shape ["+t.Id+"] selected"),!0});wc.AddEventListener(flowchart.constants.EventType.BeforeUnselect,function(n){var t=n instanceof flowchart.model.EventParamShape?n.Shape:n.ShapeConnection;return console.log("before shape ["+t.Id+"] unselected"),!0});wc.AddEventListener(flowchart.constants.EventType.AfterUnselect,function(n){var t=n instanceof flowchart.model.EventParamShape?n.Shape:n.ShapeConnection;return console.log("after shape ["+t.Id+"] unselected"),!0});setTimeout(function(){i.SetCssContentClass("test_shape_process_content");wc.UpdateShapeMetadata(i);setTimeout(function(){var n=i.Metadata;n.SetHtmlText("<div>xxx<\/div>");wc.UpdateShapeMetadata(i,n)},5e3)},5e3);UpdateJsonOutput()},function(n){var t=function(){function n(){}return n.CssClassExists=function(n){return this.GetCssClass(n)!=null},n.GetCssClass=function(n){var t,r,u,f,i,e;for(n.indexOf(".")!==0&&(n="."+n),t=0;t<document.styleSheets.length;t++)if(r=document.styleSheets[t],u=r.rules||r.cssRules,u)for(i=0,e=u;i<e.length;i++)if(f=e[i],f.selectorText==n)return f;return null},n.CreateCopy=function(n){return jQuery.extend(!0,{},n)},n.EncodeHtmlEntity=function(n){return n.replace(/./gm,function(n){return"&#"+n.charCodeAt(0)+";"})},n.DecodeHtmlEntity=function(n){return(n+"").replace(/&#\d+;/gm,function(n){var t=n.match(/\d+/gm)[0];return String.fromCharCode(t)})},n}();n.DomHelper=t}(common||(common={})),function(n){var t;(function(n){var t;(function(t){var i=function(){function t(n){this.paper=n}return t.prototype.Draw=function(t,i,r,u,f,e){var s,h,y,p,a;f===void 0&&(f=3);e===void 0&&(e=null);var c=t.getBBox(),l=i.getBBox(),o=[{x:c.x+c.width/2,y:c.y-1},{x:c.x+c.width/2,y:c.y+c.height+1},{x:c.x-1,y:c.y+c.height/2},{x:c.x+c.width+1,y:c.y+c.height/2},{x:l.x+l.width/2,y:l.y-1},{x:l.x+l.width/2,y:l.y+l.height+1},{x:l.x-1,y:l.y+l.height/2},{x:l.x+l.width+1,y:l.y+l.height/2}],nt={},k=[];for(s=0;s<4;s++)for(h=4;h<8;h++)y=Math.abs(o[s].x-o[h].x),p=Math.abs(o[s].y-o[h].y),(s==h-4||(s!=3&&h!=6||o[s].x<o[h].x)&&(s!=2&&h!=7||o[s].x>o[h].x)&&(s!=0&&h!=5||o[s].y>o[h].y)&&(s!=1&&h!=4||o[s].y<o[h].y))&&(k.push(y+p),nt[k[k.length-1]]=[s,h]);a=k.length==0?[0,4]:nt[Math.min.apply(Math,k)];var w=o[a[0]].x,v=o[a[0]].y,b=o[a[1]].x,d=o[a[1]].y;y=Math.max(Math.abs(w-b)/2,10);p=Math.max(Math.abs(v-d)/2,10);var tt=[w,w,w-y,w+y][a[0]].toFixed(3),it=[v-p,v+p,v,v][a[0]].toFixed(3),rt=[0,0,0,0,b,b,b-y,b+y][a[1]].toFixed(3),ut=[0,0,0,0,v+p,v-p,d,d][a[1]].toFixed(3),g=["M",w.toFixed(3),v.toFixed(3),"C",tt,it,rt,ut,b.toFixed(3),d.toFixed(3)].join(",");return e?(e.InnerLine.attr("stroke",r),e.OuterLine.attr({stroke:u,"stroke-width":f}),e.InnerLine.attr("path",g),e.OuterLine.attr("path",g),e):new n.RaphaelConnection(this.paper,g,r,u,f,t,i)},t}();t.Curved=i})(t=n.drawer||(n.drawer={}))})(t=n.connection||(n.connection={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t;(function(n){var t=function(){function n(){}return n.prototype.Draw=function(n,t,i,r,u,f){u===void 0&&(u=3);f===void 0&&(f=null);throw"ElbowConnection: not implemented yet.";},n}();n.Elbow=t})(t=n.drawer||(n.drawer={}))})(t=n.connection||(n.connection={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t;(function(t){var i=function(){function t(n){this.paper=n}return t.prototype.Draw=function(t,i,r,u,f,e){f===void 0&&(f=3);e===void 0&&(e=null);var o=t.getBBox(),s=i.getBBox(),c=o.x+o.width/2,l=o.y+o.height/2,a=s.x+s.width/2,v=s.y+s.height/2,h=["M",c,l,a,v].join(",");return e?(e.InnerLine.attr({stroke:r,cursor:"pointer"}),e.OuterLine.attr({stroke:u,"stroke-width":f,cursor:"pointer"}),e.InnerLine.attr("path",h),e.OuterLine.attr("path",h),e):new n.RaphaelConnection(this.paper,h,r,u,f,t,i)},t}();t.Straight=i})(t=n.drawer||(n.drawer={}))})(t=n.connection||(n.connection={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n,t,i,r,u,f,e){this.ref=n;this.InnerColor=i;this.OuterColor=r;this.Thickness=u;this.ShapeFrom=f;this.ShapeTo=e;this.OuterLine=n.path(t);this.OuterLine.attr({stroke:r,fill:"none","stroke-width":u,cursor:"pointer"});this.InnerLine=n.path(t);this.InnerLine.attr({stroke:i,fill:"none",cursor:"pointer"})}return n.prototype.RemoveFromPaper=function(){this.InnerLine.remove();this.OuterLine.remove()},n}();n.RaphaelConnection=t})(t=n.connection||(n.connection={}))}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(n){function t(t,i,r,u,f,e,o){n.call(this);this.Id=t;this.ShapeFrom=i;this.ShapeTo=r;this.Type=u;this.ConnectionPointFrom=f;this.ConnectionPointTo=e;this.RaphaelConnection=o}return __extends(t,n),t.prototype.OnSelect=function(n){this.RaphaelConnection.InnerLine.data("origStroke",this.RaphaelConnection.InnerLine.attr("stroke"));this.RaphaelConnection.OuterLine.data("origStroke",this.RaphaelConnection.OuterLine.attr("stroke"));this.RaphaelConnection.InnerLine.attr("stroke",n.ColorSelectedConnection);this.RaphaelConnection.OuterLine.attr("stroke",n.ColorSelectedConnection)},t.prototype.OnUnselect=function(){var n=this.RaphaelConnection.InnerLine.data("origStroke"),t=this.RaphaelConnection.OuterLine.data("origStroke");this.RaphaelConnection.InnerLine.attr("stroke",n);this.RaphaelConnection.OuterLine.attr("stroke",t)},t.prototype.Delete=function(){this.RaphaelConnection.RemoveFromPaper()},t}(n.model.SelectableElement);t.ShapeConnection=i})(t=n.connection||(n.connection={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){(function(n){n[n.Curved=0]="Curved";n[n.Straight=1]="Straight";n[n.Elbow=2]="Elbow"})(n.ConnectionDrawerType||(n.ConnectionDrawerType={}));var t=n.ConnectionDrawerType})(t=n.constants||(n.constants={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){(function(n){n[n.Top=0]="Top";n[n.Left=1]="Left";n[n.Right=2]="Right";n[n.Bottom=3]="Bottom"})(n.ConnectionPointPosition||(n.ConnectionPointPosition={}));var t=n.ConnectionPointPosition})(t=n.constants||(n.constants={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){(function(n){n[n.Incoming=1]="Incoming";n[n.OutgoingTrueSuccess=2]="OutgoingTrueSuccess";n[n.OutgoingFalseError=3]="OutgoingFalseError"})(n.ConnectionPointType||(n.ConnectionPointType={}));var t=n.ConnectionPointType})(t=n.constants||(n.constants={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){(function(n){n[n.TrueSucces=1]="TrueSucces";n[n.FalseError=2]="FalseError"})(n.ConnectionType||(n.ConnectionType={}));var t=n.ConnectionType})(t=n.constants||(n.constants={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){(function(n){n[n.OnClick=1]="OnClick";n[n.OnDoubleClick=2]="OnDoubleClick";n[n.BeforeConnectionCreated=3]="BeforeConnectionCreated";n[n.AfterConnectionCreated=4]="AfterConnectionCreated";n[n.BeforeShapeMoved=5]="BeforeShapeMoved";n[n.AfterShapeMoved=6]="AfterShapeMoved";n[n.BeforeDelete=7]="BeforeDelete";n[n.AfterDelete=8]="AfterDelete";n[n.BeforeSelect=9]="BeforeSelect";n[n.AfterSelect=10]="AfterSelect";n[n.BeforeUnselect=11]="BeforeUnselect";n[n.AfterUnselect=12]="AfterUnselect"})(n.EventType||(n.EventType={}));var t=n.EventType})(t=n.constants||(n.constants={}))}(flowchart||(flowchart={})),function(n){var t=function(){function t(){this.listener=[]}return t.prototype.Register=function(t,i,r){r===void 0&&(r="");var u=new n.model.EventListener(t,i,r);this.listener.push(u)},t.prototype.Unregister=function(n){var i,r,t;if(n&&n!="")for(r=this.listener.length,t=r-1;t>=0;t--)i=this.listener[t],i.Id==n&&this.listener.splice(t)},t.prototype.Notify=function(n,t){for(var e,i,u=!0,r=0,f=this.listener;r<f.length;r++)i=f[r],i.Type==n&&(e=i.Callback(t),e==!1&&(u=!1));return u},t}();n.EventHandler=t}(flowchart||(flowchart={})),function(n){var t=function(){function t(t){t===void 0&&(t=n.constants.ConnectionDrawerType.Curved);this.IsInitialized=!1;this.ColorSelectedShape="yellow";this.ColorSelectedConnection="yellow";this.ShapeConnectionType=t}return t.prototype.Init=function(t){if(!this.IsInitialized){switch(this.ShapeConnectionType){case n.constants.ConnectionDrawerType.Curved:this.ShapeConnection=new n.connection.drawer.Curved(t);break;case n.constants.ConnectionDrawerType.Straight:this.ShapeConnection=new n.connection.drawer.Straight(t)}this.IsInitialized=!0}},t}();n.FlowChartOptions=t}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n,t,i){i===void 0&&(i="");this.Id=i;this.Type=n;this.Callback=t}return n}();n.EventListener=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n){this.ShapeConnection=n}return n}();n.EventParamConnection=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n,t){this.Shapes=n;this.Connections=t}return n}();n.EventParamDeleteList=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n){this.Shape=n}return n}();n.EventParamShape=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(){this.Shapes=[];this.Connections=[]}return n}();n.ExportModel=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n){this.Id=n.Id;this.Type=n.Type;this.ShapeFromId=n.ShapeFrom.Id;this.ShapeToId=n.ShapeTo.Id;this.ConnectionPointFromPos=n.ConnectionPointFrom.Position;this.ConnectionPointToPos=n.ConnectionPointTo.Position}return n}();n.ExportModelConnection=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n){this.Type=n.PointType;this.Pos=n.Position}return n}();n.ExportModelConnectionPoint=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function t(t){var u,i,r;for(this.ConnectionPoints=[],this.Id=t.Id,this.Width=t.Width,this.Height=t.Height,this.Type=t.Type,this.Metadata=common.DomHelper.EncodeHtmlEntity(t.Metadata.GetHtml().innerHTML),this.PosX=t.RaphaelElement.attr("x"),this.PosY=t.RaphaelElement.attr("y"),i=0,r=t.ConnectionPoints;i<r.length;i++)u=r[i],this.ConnectionPoints.push(new n.ExportModelConnectionPoint(u))}return t}();n.ExportModelShape=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function t(){this.Shapes=[]}return t.prototype.Export=function(){for(var e,i,o,s,r,h,l,u,t=new n.ExportModel,f=0,c=this.Shapes;f<c.length;f++)for(u=c[f],t.Shapes.push(new n.ExportModelShape(u)),i=0,o=u.Connections;i<o.length;i++){for(e=o[i],s=!1,r=0,h=t.Connections;r<h.length;r++)if(l=h[r],l.Id==e.Id){s=!0;break}s||t.Connections.push(new n.ExportModelConnection(e))}return t},t.prototype.DeleteShape=function(n){this.DeleteConnections(n.Connections);for(var t=0;t<this.Shapes.length;t++)if(this.Shapes[t].Id==n.Id){this.Shapes.splice(t,1);break}},t.prototype.DeleteConnections=function(n){for(var r,u,t,f=n.length,i=f-1;i>=0;i--)t=n[i],r=this.GetShape(t.ShapeFrom.Id),u=this.GetShape(t.ShapeTo.Id),this.DeleteConnectionFromShape(r,t.Id),this.DeleteConnectionFromShape(u,t.Id)},t.prototype.DeleteConnectionFromShape=function(n,t){for(var i=0;i<n.Connections.length;i++)if(n.Connections[i].Id==t){n.Connections.splice(i,1);break}},t.prototype.GetShape=function(n){for(var r,t=0,i=this.Shapes;t<i.length;t++)if(r=i[t],r.Id==n)return r;return null},t}();n.FlowChartModel=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(){this.Shapes={};this.ConnectionDrawer={}}return n.prototype.GetShape=function(n){return this.Shapes[n]},n.prototype.GetConnectionDrawer=function(n){return this.ConnectionDrawer[n]},n.prototype.AddShape=function(n,t){this.Shapes[n]=t},n.prototype.AddConnectionDrawer=function(n,t){this.ConnectionDrawer[n]=t},n}();n.NamespaceRegistry=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t=function(){function n(n,t){this.X=n;this.Y=t}return n}();n.ShapePosition=t})(t=n.model||(n.model={}))}(flowchart||(flowchart={})),function(n){var t=function(){function t(n,t){this.flowChart=n;this.namespaceRegistrator=t}return t.prototype.Load=function(n){this.flowChart.Clear();this.AddShapes(n.Shapes);this.ConnectShapes(n.Connections)},t.prototype.AddShapes=function(t){for(var f,h,r,o,i,u=0,s=t;u<s.length;u++){i=s[u];f=new n.shape.metadata.Html("");h=common.DomHelper.DecodeHtmlEntity(i.Metadata);f.SetHtmlText(h);var a=this.namespaceRegistrator.GetShape(i.Type),c=new a(i.Id,i.Width,i.Height,f),l=[],e;for(r=0,o=i.ConnectionPoints;r<o.length;r++)e=o[r],l.push(new n.shape.ConnectionPoint(e.Type,e.Pos));c.AddConnectionPoints(l);this.flowChart.AddShape(c,i.PosX,i.PosY)}},t.prototype.ConnectShapes=function(n){for(var u,f,t,i=0,r=n;i<r.length;i++)t=r[i],u=this.flowChart.GetShape(t.ShapeFromId),f=this.flowChart.GetShape(t.ShapeToId),this.flowChart.ConnectShapes(u,f,t.ConnectionPointFromPos,t.ConnectionPointToPos)},t}();n.ModelLoader=t}(flowchart||(flowchart={})),function(n){var t=function(){function t(){this.Registry=new n.model.NamespaceRegistry;this.RegisterBuildIn()}return t.prototype.RegisterBuildIn=function(){this.RegisterShape(n.constants.ShapeType.Terminal,n.shape.Terminal);this.RegisterShape(n.constants.ShapeType.Decision,n.shape.Decision);this.RegisterShape(n.constants.ShapeType.Process,n.shape.Process);this.RegisterShape(n.constants.ShapeType.ConnectionPoint,n.shape.ConnectionPoint);this.RegisterConnectionDrawer(n.constants.ConnectionDrawerType.Straight,n.connection.drawer.Straight);this.RegisterConnectionDrawer(n.constants.ConnectionDrawerType.Curved,n.connection.drawer.Curved)},t.prototype.GetShape=function(n){var t=this.Registry.GetShape(n);if(!t)throw"No Shape registered under enum-value ["+n+"].";return t},t.prototype.GetConnectionDrawer=function(n){var t=this.Registry.GetConnectionDrawer(n);if(!t)throw"No Connection-Drawer registered under enum-value ["+n+"].";return t},t.prototype.RegisterShape=function(n,t){if(this.Registry.Shapes[n])throw"Shape with enum-value ["+n+"] already registered. Can't register ["+t+"] with the same enum-value.";this.Registry.AddShape(n,t)},t.prototype.RegisterConnectionDrawer=function(n,t){if(this.Registry.ConnectionDrawer[n])throw"ConnectionDrawer with enum-value ["+n+"] already registered. Can't register ["+t+"] with the same enum-value.";this.Registry.AddConnectionDrawer(n,t)},t}();n.NamespaceRegistrator=t}(flowchart||(flowchart={})),function(n){var t=function(){function t(t,i,r){var u=this,f;this.eventHandler=t;this.options=i;this.flowchartModel=r;this.SelectedElements=[];this.IsCtrl=!1;this.IsMouseHold=!1;this.isMouseUp=!1;this.eventHandler.Register(n.constants.EventType.OnClick,function(t){if(u.IsMouseHold)return!1;if(t instanceof n.model.EventParamConnection)u.SelectionChanged(t.ShapeConnection);else if(t instanceof n.model.EventParamShape)u.SelectionChanged(t.Shape);else return console.warn("element ["+t+"] shouldn't be selectable..."),!1;return!0});document.body.onkeydown=function(t){var r,f,e,o,i;if(u.IsCtrl=t.keyCode===17,t.keyCode==46){if(u.SelectedElements.length===0)return!1;for(r=[],f=[],e=0,o=u.SelectedElements;e<o.length;e++)i=o[e],i instanceof n.connection.ShapeConnection?f.push(i):i instanceof n.shape.ShapeBase&&r.push(i);if(u.eventHandler.Notify(n.constants.EventType.BeforeDelete,new n.model.EventParamDeleteList(r,f))===!1)return!1;u.DeleteElements();u.eventHandler.Notify(n.constants.EventType.AfterDelete,new n.model.EventParamDeleteList(r,f))}};document.body.onkeyup=function(){u.IsCtrl=!1};document.body.onmousedown=function(){u.IsMouseHold=!1;u.isMouseUp=!1;console.log("onmousedown");f=setTimeout(function(){u.IsMouseHold=!u.isMouseUp},200)};document.body.onmouseup=function(){clearTimeout(f);console.log("onmouseup");u.isMouseUp=!0}}return t.prototype.DeleteElements=function(){for(var o,e,i,u,t,r=0,f=this.SelectedElements;r<f.length;r++){if(t=f[r],o=t.Id,t instanceof n.shape.ShapeBase){for(i=0,u=t.Connections;i<u.length;i++)e=u[i],e.Delete();this.flowchartModel.DeleteShape(t)}else t instanceof n.connection.ShapeConnection&&this.flowchartModel.DeleteConnections([t]);t.Delete()}},t.prototype.SelectionChanged=function(t){var i,u,r,s,e,f,o;if(console.log("isCtrl="+this.IsCtrl),console.log("count selected="+this.SelectedElements.length),this.IsCtrl){for(u=-1,r=0;r<this.SelectedElements.length;r++)if(s=this.SelectedElements[r],s.Id==t.Id){u=r;break}if(u>-1)return this.NotifySelectionChanged(n.constants.EventType.BeforeUnselect,t)===!1?!1:(t.OnUnselect(this.options),this.SelectedElements.splice(u,1),this.NotifySelectionChanged(n.constants.EventType.AfterUnselect,t),!0);if(this.NotifySelectionChanged(n.constants.EventType.BeforeSelect,t)===!1)return!1;t.OnSelect(this.options);this.NotifySelectionChanged(n.constants.EventType.AfterSelect,t);this.SelectedElements.push(t)}else{for(e=!1,f=0,o=this.SelectedElements;f<o.length;f++){if(i=o[f],this.NotifySelectionChanged(n.constants.EventType.BeforeUnselect,i)===!1)return!1;i.OnUnselect(this.options);this.NotifySelectionChanged(n.constants.EventType.AfterUnselect,i);i.Id==t.Id&&(e=!0)}if(this.SelectedElements=[],e)return!0;if(this.NotifySelectionChanged(n.constants.EventType.BeforeSelect,t)===!1)return!1;t.OnSelect(this.options);this.NotifySelectionChanged(n.constants.EventType.AfterSelect,t);this.SelectedElements.push(t)}return!0},t.prototype.NotifySelectionChanged=function(t,i){var r=i instanceof n.shape.ShapeBase?new n.model.EventParamShape(i):new n.model.EventParamConnection(i);if(this.eventHandler.Notify(t,r)===!1)return!1},t}();n.SelectionManager=t}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(t){function i(i,r,u,f){u===void 0&&(u=30);f===void 0&&(f=30);t.call(this,"",n.constants.ShapeType.ConnectionPoint,u,f,null,"");this.PointType=i;this.Position=r;var e=n.constants.ConnectionPointType;switch(i){case e.Incoming:this.CssBackgroundClass="connection_point_incoming";this.CssContentClass="";break;case e.OutgoingTrueSuccess:this.CssBackgroundClass="connection_point_outgoing_true_success";this.CssContentClass="";break;case e.OutgoingFalseError:this.CssBackgroundClass="connection_point_outgoing_false_error";this.CssContentClass=""}}return __extends(i,t),i.prototype.DrawShape=function(t){var h=this.ParentShape.RaphaelElement,e=h.getBBox(),r=0,u=0,o=5,s=this.ParentShape.CalculateConnectionPointCoord(this.Position,o,5),i,f;return r=s.x,u=s.y,r===0&&(r=e.x,u=e.y),i=t.circle(r,u,o),i.data("shape",this),f=common.DomHelper.GetCssClass(this.CssBackgroundClass),f&&i.attr({fill:f.style["background-color"]}),this.PointType!=n.constants.ConnectionPointType.Incoming&&i.attr({cursor:"crosshair"}),i},i.prototype.GetPosition=function(){return new n.model.ShapePosition(this.RaphaelElement.attr("cx"),this.RaphaelElement.attr("cy"))},i.prototype.SetPosition=function(n,t){this.RaphaelElement.attr({cx:n,cy:t})},i.prototype.GetMetadataDiv=function(){return null},i.prototype.CreateCopy=function(){var n=new i(this.PointType,this.Position,this.Width,this.Height);return n.RaphaelElement=this.RaphaelElement.clone(),n},i.prototype.OnSelect=function(){},i.prototype.OnUnselect=function(){},i}(t.ShapeBase);t.ConnectionPoint=i})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t;(function(n){var t;(function(n){var t=function(){function n(n,t){t===void 0&&(t="");this.Label=n;this.Icon=t;this.CreateHtml()}return n.prototype.CreateHtml=function(){var n=document.createElement("div");n.style.width="100%";n.style.height="100%";n.innerHTML="   <div>"+this.Label+"<\/div>";this.Html=n},n.prototype.SetHtml=function(n){this.Html=n},n.prototype.SetHtmlText=function(n){this.Html.innerHTML=n},n.prototype.GetHtml=function(){return this.Html},n}();n.Html=t})(t=n.metadata||(n.metadata={}))})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t;(function(t){var i=function(t){function i(i,r,u,f){f===void 0&&(f=null);t.call(this,i,n.constants.ShapeType.Terminal,r,u,f,"shape_terminal")}return __extends(i,t),i.prototype.DrawShape=function(n,t,i){var u=this.CalculatePath(t,i,this.Width,this.Height),r=n.path(u);return r.attr({x:t,y:i}),r.attr(this.RaphaelAttr),r},i.prototype.CalculatePath=function(n,t,i,r){var f=20,e=20,o=20,s=20,u=[];return u=u.concat(["M",n+f,t]),u=u.concat(["l",i-f-e,0]),u=u.concat(["q",e,0,e,e]),u=u.concat(["l",0,r-o-e]),u=u.concat(["q",0,o,-o,o]),u=u.concat(["l",-i+s+o,0]),u=u.concat(["q",-s,0,-s,-s]),u=u.concat(["l",0,-r+s+f]),u=u.concat(["q",0,-f,f,-f]),u=u.concat(["z"]),u.join(" ")},i.prototype.GetMetadataDiv=function(){var n=document.createElement("div");return n.classList.add(this.CssBackgroundClass),n},i.prototype.GetPosition=function(){return new n.model.ShapePosition(this.RaphaelElement.attr("x"),this.RaphaelElement.attr("y"))},i.prototype.SetPosition=function(n,t){var i=this.CalculatePath(n,t,this.Width,this.Height);this.RaphaelElement.node.setAttribute("d",i);this.RaphaelElement.attr({x:n,y:t})},i.prototype.OnSelect=function(n){this.RaphaelElement.data("origStroke",this.RaphaelElement.attr("stroke"));this.RaphaelElement.attr("stroke",n.ColorSelectedShape)},i.prototype.OnUnselect=function(){var n=this.RaphaelElement.data("origStroke");this.RaphaelElement.attr("stroke",n)},i}(t.ShapeBase);t.Terminal=i})(t=n.shape||(n.shape={}))}(flowchart||(flowchart={})),function(n){var t=function(){function t(n,t,i){this.paper=n;this.options=t;this.eventHandler=i;this.connectionCounter=0}return t.prototype.GetConnectionPoint=function(n,t){for(var i,r=0,u=n.ConnectionPoints;r<u.length;r++)if(i=u[r],i.Position==t)return i;throw"Shape has not connection-point at position "+t;},t.prototype.Connect=function(t,i,r,u){var f=this.GetConnectionPoint(t,r),s=this.GetConnectionPoint(i,u),h=f.RaphaelElement.attr("fill"),o=this.ConnectShapes(f.RaphaelElement,s.RaphaelElement,h,h,3),l=f.PointType==n.constants.ConnectionPointType.OutgoingTrueSuccess?n.constants.ConnectionType.TrueSucces:n.constants.ConnectionType.FalseError,c,e;return this.connectionCounter++,c="conn_"+this.connectionCounter,e=new n.connection.ShapeConnection(c,t,i,l,f,s,o),this.AddEventsToConnectionLine(o,e),t.AddConnection(e),i.AddConnection(e),o},t.prototype.AddEventsToConnectionLine=function(t,i){var r=this;t.InnerLine.click(function(){r.eventHandler.Notify(n.constants.EventType.OnClick,new n.model.EventParamConnection(i))});t.OuterLine.click(function(){r.eventHandler.Notify(n.constants.EventType.OnClick,new n.model.EventParamConnection(i))})},t.prototype.RefreshConnection=function(n){var t=n.InnerLine.attr("stroke")?n.InnerLine.attr("stroke"):n.InnerColor,i=n.OuterLine.attr("stroke")?n.OuterLine.attr("stroke"):n.OuterColor;this.ConnectShapes(n.ShapeFrom,n.ShapeTo,t,i,n.Thickness,n)},t.prototype.ConnectShapes=function(n,t,i,r,u,f){u===void 0&&(u=3);f===void 0&&(f=null);var e=this.options.ShapeConnection;return e.Draw(n,t,i,r,u,f)},t}();n.ShapeConnector=t}(flowchart||(flowchart={})),function(n){var t=function(){function t(n,t,i,r){this._connector=n;this.options=i;this.eventHandler=r;this.Paper=t}return t.prototype.Register=function(t){var i,r,u;for(t.RaphaelElement.drag(this.GetOnMoveStart(t),this.GetDragger(t),this.GetOnMoveFinished(t)),t.RaphaelElement.mouseover(this.GetOnMouseOver(t)),t.RaphaelElement.mouseout(this.GetOnMouseOut(t)),r=0,u=t.ConnectionPoints;r<u.length;r++){i=u[r];switch(i.PointType){case n.constants.ConnectionPointType.OutgoingTrueSuccess:case n.constants.ConnectionPointType.OutgoingFalseError:i.RaphaelElement.drag(this.GetOnMoveStart(i),this.GetDragger(i),this.GetOnMoveFinished(i));break;case n.constants.ConnectionPointType.Incoming:i.RaphaelElement.mouseover(this.GetOnMouseOver(i));i.RaphaelElement.mouseout(this.GetOnMouseOut(i))}}},t.prototype.IsConnectionPoint=function(t){return t&&t.data("shape").Type===n.constants.ShapeType.ConnectionPoint},t.prototype.IsConnectionPointType=function(n,t){var r,i,u,f;if(!this.IsConnectionPoint(n.RaphaelElement))return!1;for(r=n,console.log(r.PointType),i=0,u=t;i<u.length;i++)if(f=u[i],r.PointType==f)return!0;return!1},t.prototype.GetOnMoveStart=function(n){var t=this;return function(i,r){var e,u,f;for(n.OnMove(i,r),u=0,f=n.Connections;u<f.length;u++)e=f[u],t._connector.RefreshConnection(e.RaphaelConnection);return t.IsConnectionPoint(this)&&t._connector.RefreshConnection(t.DragConnection),this}},t.prototype.GetOnMoveFinished=function(){var t=this;return function(){var f,i,e;if(!t.IsConnectionPoint(this)){f=new n.model.EventParamShape(this.data("shape"));t.eventHandler.Notify(n.constants.EventType.AfterShapeMoved,f);return}if((t.DragConnection.RemoveFromPaper(),t.PlaceholderConnectionPoint.RaphaelElement.remove(),t.PlaceholderConnectionPoint=null,t.DragFromConnectionPoint=null,t.DragConnection=null,i=this.data("shape"),i.SetPosition(this.ox,this.oy),t.CurrentOverShape!=null)&&(this.toFront(),t.IsConnectionPointType(t.CurrentOverShape,[n.constants.ConnectionPointType.Incoming]))){if(!t.IsConnectionAllowed(i,t.CurrentOverShape))return;var r=t.CurrentOverShape,o=i.ParentShape,s=r.ParentShape,h=i.PointType==n.constants.ConnectionPointType.OutgoingTrueSuccess?n.constants.ConnectionType.TrueSucces:n.constants.ConnectionType.FalseError,u=new n.model.EventParamConnection(new n.connection.ShapeConnection("",o,s,h,i,r,null));if(t.eventHandler.Notify(n.constants.EventType.BeforeConnectionCreated,u)===!1)return;e=t._connector.Connect(i.ParentShape,r.ParentShape,i.Position,r.Position);u.ShapeConnection.RaphaelConnection=e;t.eventHandler.Notify(n.constants.EventType.AfterConnectionCreated,u)}}},t.prototype.GetDragger=function(t){var i=this;return function(r,u){var o,f,e,s;i.CurrentDraggedShapeType=t.Type;t.BeforeMove(r,u);i.IsConnectionPoint(this)?(o=t,i.DragFromConnectionPoint=t,i.PlaceholderConnectionPoint=o.CreateCopy(),f=this.attr("fill"),e={"stroke-dasharray":["-"],"arrow-end":"classic"},i.DragConnection=i.options.ShapeConnection.Draw(i.PlaceholderConnectionPoint.RaphaelElement,this,f,f,5),i.DragConnection.InnerLine.attr(e),i.DragConnection.OuterLine.attr(e),this.toBack()):(s=new n.model.EventParamShape(this.data("shape")),i.eventHandler.Notify(n.constants.EventType.BeforeShapeMoved,s))}},t.prototype.GetOnMouseOver=function(t){var i=this;return function(){if(i.CurrentOverShape=t,i.IsConnectionPoint(this)&&i.IsDragging()&&i.IsConnectionPointType(t,[n.constants.ConnectionPointType.Incoming])){if(!i.IsConnectionAllowed(i.DragFromConnectionPoint,i.CurrentOverShape))return;var r=this.attr("fill"),u={fill:r,r:20};this.toFront();this.animate(Raphael.animation({r:u.r},250))}}},t.prototype.GetOnMouseOut=function(){var n=this;return function(){var t=this;if(n.IsConnectionPoint(this)){var i=this.attr("fill"),r={fill:i,r:5},u=Raphael.animation({r:r.r},250,null,function(){var r,e,u,i,f;if(!n.IsDragging())for(r=t.data("shape").ParentShape,e=r.Id,i=0,f=r.Connections;i<f.length;i++)u=f[i],u.ShapeTo.Id==e&&n._connector.RefreshConnection(u.RaphaelConnection)});this.animate(u)}}},t.prototype.IsDragging=function(){return this.DragConnection!=null},t.prototype.IsConnectionAllowed=function(n,t){var f=n.ParentShape,e=t.ParentShape,r,i,u;if(f.Id==e.Id)return!1;for(i=0,u=f.Connections;i<u.length;i++)if(r=u[i],r.ShapeTo.Id==e.Id&&r.ConnectionPointFrom.PointType==n.PointType)return!1;return!0},t}();n.ShapeMover=t}(flowchart||(flowchart={}));